## 1. 問題タイトル

83 本目：太陽系シミュレーション（階層構造）

## 2. 学習目標

この演習を通じて、以下の技術を習得します。

- `Group` を使ったオブジェクトの階層化（親子関係）
- ローカル座標系での回転と公転の実装
- 複数の回転軸の制御

## 3. 新しい概念の解説

**Hierarchical Transformation / Local Coordinates（階層的な変換・ローカル座標）**
3D 空間では、オブジェクトを別のオブジェクトの「子」にすることで、親の動き（移動・回転・拡大縮小）をそのまま継承させることができます。
これを応用し、太陽を中心に地球を回し（公転）、さらに地球を中心に月を回すといった複雑な動きを、単純な「親の回転」だけで実現します。

```javascript
const sun = new THREE.Mesh(...);

// 地球の軌道（空のグループ）を太陽の子にする
const earthOrbit = new THREE.Group();
sun.add(earthOrbit);

// 地球を軌道グループの子にし、位置をずらす（半径）
const earth = new THREE.Mesh(...);
earth.position.x = 10;
earthOrbit.add(earth);

function animate() {
  // 親（軌道）を回すと、子（地球）も一緒に回る＝公転
  earthOrbit.rotation.y += 0.01;
  // 地球自身を回す＝自転
  earth.rotation.y += 0.05;
}
```

## 4. 課題の説明

太陽、地球、月を作成し、それぞれの動きをシミュレートしてください。

- 地球は太陽の周りを回る（公転）。
- 地球は自分自身も回る（自転）。
- 月は地球の周りを回る。
  これを `add` メソッドを使って親子関係を作ることで、複雑な計算なしに実現します。

## 5. 必須要件

以下の機能を実装してください。

- **太陽の作成**:
  大きな球体を作成し、シーンの中央（0,0,0）に配置します（`scene.add(sun)`）。

- **地球システム（公転と自転）**:
  1. `earthOrbit`（空の `THREE.Group`）を作成し、太陽の子にします（`sun.add(earthOrbit)`）。
  2. `earth`（球体）を作成し、軌道グループの子にします（`earthOrbit.add(earth)`）。
  3. `earth.position.x = 5` のように位置をずらし、公転半径を設定します。

- **月システム**:
  1. `moonOrbit`（空の `Group`）を作成し、**地球の子**にします（`earth.add(moonOrbit)`）。
  2. `moon`（小さな球体）を作成し、月の軌道グループの子にします（`moonOrbit.add(moon)`）。
  3. `moon.position.x = 1.5` のように位置をずらします。

- **アニメーション**:
  `animate` ループ内で以下のように回転を加えます。
  - `earthOrbit.rotation.y`（地球の公転）
  - `earth.rotation.y`（地球の自転）
  - `moonOrbit.rotation.y`（月の公転）
  これにより、複雑な軌道計算なしに連動した動きが実現できます。

## 6. ヒント

- **ヒント 1（階層構造の魔法）**:
  Scene -> Sun -> EarthOrbit -> Earth -> MoonOrbit -> Moon
  という構造を作ります。EarthOrbit は何も表示しない `Group`（ピボット）です。
- **ヒント 2（公転と自転の分離）**:
  「EarthOrbit」を回すと地球が公転します。「Earth」自体を回すと自転します。
  これにより、公転と自転の速度を独立して制御できます。
- **ヒント 3（ローカル座標）**:
  `Earth.position.x = 10` とすると、親である EarthOrbit の中心から 10 離れた場所に配置されます。
  親が回れば、この「10 離れた状態」を維持したまま回ります。
- **ヒント 4（月の配置）**:
  月も同様に、地球の中心にある `MoonOrbit` グループの子にし、少しずらして配置します。
  こうすれば地球が移動しても、月は自動的に付いていきます。
- **ヒント 5（スケール感）**:
  実際の比率（太陽と地球の距離など）で作ると何も見えなくなるので、デモ用に距離を縮め、惑星を大きくして見やすくしましょう。

## 7. スターターコード

```javascript
import * as THREE from "three";

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(
  75,
  window.innerWidth / window.innerHeight,
  0.1,
  1000
);
const renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// 太陽
const sun = new THREE.Mesh(
  new THREE.SphereGeometry(1),
  new THREE.MeshBasicMaterial({ color: 0xffff00 })
);
scene.add(sun);

// --- ここで地球と月を作成し、親子関係を設定 ---

camera.position.z = 10;

function animate() {
  requestAnimationFrame(animate);

  // --- ここで回転 ---

  renderer.render(scene, camera);
}
animate();
```

## 8. 模範解答

```javascript
import * as THREE from "three";

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(
  75,
  window.innerWidth / window.innerHeight,
  0.1,
  1000
);
const renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// 太陽
const sun = new THREE.Mesh(
  new THREE.SphereGeometry(1.5),
  new THREE.MeshBasicMaterial({ color: 0xffff00 })
);
scene.add(sun);

// 地球の公転用グループ（太陽の中心に配置）
const earthOrbit = new THREE.Group();
sun.add(earthOrbit);

// 地球
const earth = new THREE.Mesh(
  new THREE.SphereGeometry(0.5),
  new THREE.MeshBasicMaterial({ color: 0x0000ff })
);
earth.position.x = 5; // 太陽からの距離
earthOrbit.add(earth);

// 月の公転用グループ（地球の中心に配置）
const moonOrbit = new THREE.Group();
earth.add(moonOrbit);

// 月
const moon = new THREE.Mesh(
  new THREE.SphereGeometry(0.15),
  new THREE.MeshBasicMaterial({ color: 0x888888 })
);
moon.position.x = 1.5; // 地球からの距離
moonOrbit.add(moon);

camera.position.z = 10;
camera.position.y = 5;
camera.lookAt(0, 0, 0);

function animate() {
  requestAnimationFrame(animate);

  sun.rotation.y += 0.005; // 太陽自転
  earthOrbit.rotation.y += 0.01; // 地球公転
  earth.rotation.y += 0.02; // 地球自転
  moonOrbit.rotation.y += 0.05; // 月公転

  renderer.render(scene, camera);
}
animate();
```
