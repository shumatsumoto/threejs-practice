## 1. 問題タイトル

36 本目：アニメーション付き GLTF モデル

## 2. 学習目標

この演習を通じて、以下の技術を習得します。

- `THREE.AnimationMixer` の使用方法
- GLTF に含まれるアニメーションデータの再生
- `clock.getDelta()` を使ったフレーム更新

## 3. 新しい概念の解説

**AnimationMixer（アニメーションミキサー）**
モデルに含まれるアニメーションを再生・管理するためのプレイヤーです。
ミキサーに「何秒経過したか（Delta Time）」を毎フレーム教えることで、滑らかにアニメーションが進行します。
一つのミキサーで、複数のアクション（走る、ジャンプするなど）を切り替えて再生することもできます。

**Animation Clip & Action**
- Clip: アニメーションのデータそのもの（「走り」の動きデータなど）
- Action: Clip を実際に再生するためのコントローラー（再生、停止、フェードインなど）

```javascript
let mixer;
const clock = new THREE.Clock();

loader.load('model.glb', (gltf) => {
  const model = gltf.scene;
  scene.add(model);
  
  // ミキサー作成
  mixer = new THREE.AnimationMixer(model);
  
  // アニメーション再生（最初のクリップ）
  const clip = gltf.animations[0];
  const action = mixer.clipAction(clip);
  action.play();
});

function animate() {
  requestAnimationFrame(animate);
  if (mixer) {
    // 前回フレームからの経過時間分だけ進める
    mixer.update(clock.getDelta());
  }
  renderer.render(scene, camera);
}
```

## 4. 課題の説明

アニメーションデータが含まれている GLTF モデルを読み込み、そのアニメーション（歩行や回転など）を再生してください。
モデルを読み込むだけでは動かないため、ミキサー（Mixer）を使ってアニメーションを進行させる必要があります。

## 5. 必須要件

以下の機能を実装してください。

- **モデルとアニメーションの読み込み**:
  `GLTFLoader` を使用して、アニメーションデータを含むモデル（`Fox.glb` や `Soldier.glb` など）を読み込みます。

- **Mixerの作成**:
  読み込んだモデル（`gltf.scene`）を対象とした `THREE.AnimationMixer` インスタンスを作成します。
  `mixer = new THREE.AnimationMixer(gltf.scene);`

- **Actionの再生**:
  `gltf.animations` 配列からクリップ（`AnimationClip`）を取得します。
  `mixer.clipAction(clip).play()` を呼び出して、再生状態にします。

- **アニメーション更新ループ**:
  `THREE.Clock` を作成し、`animate` 関数内で `const delta = clock.getDelta()` を取得します。
  `mixer.update(delta)` を毎フレーム呼び出して、アニメーションを進行させます。

## 6. ヒント

- **ヒント 1（Mixerの作成）**:
  `mixer = new THREE.AnimationMixer(model);`
  再生機（Mixer）を作成し、動かしたいモデル（model）をセットします。
- **ヒント 2（再生のアクション）**:
  `const action = mixer.clipAction(gltf.animations[0]);`
  データ内の最初のアニメーションクリップを取り出し、アクションを作って `.play()` します。
- **ヒント 3（更新ループ）**:
  `animate` 関数内で常に `mixer.update(delta)` を呼ぶ必要があります。
  これを忘れると、アニメーションは 1 フレーム目で止まったままになります。
- **ヒント 4（Clockの使用）**:
  `const delta = clock.getDelta();`
  前のフレームから何秒経過したか（Delta Time）を取得し、Mixer に渡します。これにより PC の性能に関わらず一定速度で再生されます。
- **ヒント 5（変数のスコープ）**:
  `mixer` 変数はロード関数の中だけでなく、`animate` 関数からも参照できるように、外側のスコープで定義（`let mixer`）しておく必要があります。

## 7. スターターコード

```javascript
import * as THREE from "three";
import { GLTFLoader } from "three/examples/jsm/loaders/GLTFLoader";

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(
  75,
  window.innerWidth / window.innerHeight,
  0.1,
  1000
);
const renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const light = new THREE.DirectionalLight(0xffffff, 2);
light.position.set(2, 2, 2);
scene.add(light);

let mixer; // アニメーション管理用
const clock = new THREE.Clock();

const loader = new GLTFLoader();
loader.load(
  "https://threejs.org/examples/models/gltf/RobotExpressive/RobotExpressive.glb",
  (gltf) => {
    const model = gltf.scene;
    scene.add(model);

    // --- ここでアニメーション再生の準備 ---
  }
);

camera.position.set(0, 2, 5);

function animate() {
  requestAnimationFrame(animate);

  // --- ここでMixerを更新 ---

  renderer.render(scene, camera);
}
animate();
```

## 8. 模範解答

```javascript
import * as THREE from "three";
import { GLTFLoader } from "three/examples/jsm/loaders/GLTFLoader";

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(
  75,
  window.innerWidth / window.innerHeight,
  0.1,
  1000
);
const renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const light = new THREE.DirectionalLight(0xffffff, 2);
light.position.set(5, 5, 5);
scene.add(light);
const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
scene.add(ambientLight);

let mixer;
const clock = new THREE.Clock();

const loader = new GLTFLoader();
loader.load(
  "https://threejs.org/examples/models/gltf/RobotExpressive/RobotExpressive.glb",
  (gltf) => {
    const model = gltf.scene;
    model.scale.set(0.5, 0.5, 0.5);
    scene.add(model);

    // 1. Mixerの作成
    mixer = new THREE.AnimationMixer(model);

    // 2. アニメーションの取得と再生
    // gltf.animations には複数のクリップが入っている場合がある
    // ここでは最初のクリップ（Runningなど）を再生
    const clip = gltf.animations[0];
    const action = mixer.clipAction(clip);
    action.play();
  }
);

camera.position.set(0, 2, 5);
camera.lookAt(0, 1, 0);

function animate() {
  requestAnimationFrame(animate);

  // 3. Mixerの更新
  if (mixer) {
    const delta = clock.getDelta();
    mixer.update(delta);
  }

  renderer.render(scene, camera);
}
animate();
```
