## 1. 問題タイトル

97 本目：AR 体験の基礎（WebXR AR）

## 2. 学習目標

この演習を通じて、以下の技術を習得します。

- AR（拡張現実）モードの有効化
- `ARButton` の使用
- カメラ背景透過の設定

## 3. 新しい概念の解説

**WebXR AR (拡張現実)**
Web ブラウザ上で AR（拡張現実）体験を実現する標準規格です。
スマートフォンのカメラ映像を背景として描画し、その上に 3D オブジェクトを合成します。
`ARButton` を使うことで、対応デバイス（Android の Chrome など）で「AR モードを開始」するボタンを簡単に設置でき、セッション管理を自動化できます。
背景を透明（`alpha: true`）にしないとカメラ映像が見えない点に注意が必要です。

```javascript
import { ARButton } from 'three/examples/jsm/webxr/ARButton';

// 1. 背景透過でレンダラー作成
const renderer = new THREE.WebGLRenderer({ alpha: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.xr.enabled = true; // XRモード有効化

// 2. ARボタンをHTMLに追加
document.body.appendChild(ARButton.createButton(renderer));

// 3. アニメーションループ（requestAnimationFrameではなくsetAnimationLoopを使う）
renderer.setAnimationLoop(function () {
  renderer.render(scene, camera);
});
```

## 4. 課題の説明

スマートフォンのカメラ映像の上に 3D オブジェクトを重ねて表示する AR（Augmented Reality）コンテンツを作成してください。
WebXR の AR モードを使用します。

## 5. 必須要件

以下の機能を実装してください。

- **AR用レンダラーの設定**:
  `new THREE.WebGLRenderer({ alpha: true })` でレンダラーを作成します（`alpha: true` はカメラ背景を表示するために必須）。
  `renderer.xr.enabled = true` を設定して WebXR モードを有効化します。

- **ARボタンの配置**:
  `ARButton.createButton(renderer)` を呼び出してボタン要素を生成し、`document.body` に追加します。これにより、対応デバイスで「Start AR」ボタンが表示されます。

- **シーン構築**:
  AR 空間に表示するオブジェクト（例：小さな立方体 `0.1m` サイズ）を作成し、初期位置を `(0, 0, -0.3)` （30cm前方）などに設定して `scene.add` します。

- **レンダリングループ**:
  WebXR コンテンツでは `requestAnimationFrame` は使えません。
  代わりに `renderer.setAnimationLoop(callback)` を使用して、回転アニメーションと描画処理 (`renderer.render`) を記述します。

## 6. ヒント

- **ヒント 1（透過設定）**:
  `new THREE.WebGLRenderer({ alpha: true })` が必須です。
  これを忘れると、背景が黒くなり、カメラ映像が見えません。
- **ヒント 2（スケール感）**:
  AR/VR の世界では 1 単位 = 1 メートルが標準です。
  `BoxGeometry(1, 1, 1)` は 1m の巨大な箱になります。室内でテストするなら `0.1`（10cm）程度が適切です。
- **ヒント 3（ループ処理）**:
  WebXR ではブラウザの描画タイミングに合わせるため、`requestAnimationFrame` ではなく `renderer.setAnimationLoop(callback)` を使う必要があります。
- **ヒント 4（ライト）**:
  カメラ映像には現実の光が含まれていますが、3D オブジェクトは計算上の光しか受けません。
  `HemisphereLight` などを使って、少し明るめに照らすと馴染みやすいです。
- **ヒント 5（テスト環境）**:
  PC モニターでは基本的に動きません。WebXR 対応の Android 端末（Chrome）か、Chrome 拡張機能の WebXR エミュレーターを使用してください。

## 7. スターターコード

```javascript
import * as THREE from "three";
// import { ARButton } ...

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(
  75,
  window.innerWidth / window.innerHeight,
  0.1,
  1000
);

// 背景透過
const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.xr.enabled = true;
document.body.appendChild(renderer.domElement);

// document.body.appendChild(ARButton.createButton(renderer));

const cube = new THREE.Mesh(
  new THREE.BoxGeometry(0.2, 0.2, 0.2),
  new THREE.MeshNormalMaterial()
);
cube.position.set(0, 0, -0.5); // スマホの少し前
scene.add(cube);

renderer.setAnimationLoop(function () {
  cube.rotation.x += 0.01;
  cube.rotation.y += 0.01;
  renderer.render(scene, camera);
});
```

## 8. 模範解答

```javascript
import * as THREE from "three";
import { ARButton } from "three/examples/jsm/webxr/ARButton";

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(
  70,
  window.innerWidth / window.innerHeight,
  0.01,
  20
);

// ARでは背景を透明にする必要がある
const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.xr.enabled = true;
document.body.appendChild(renderer.domElement);

// ARボタン
document.body.appendChild(ARButton.createButton(renderer));

// 小さめのキューブ
const geometry = new THREE.BoxGeometry(0.1, 0.1, 0.1);
const material = new THREE.MeshNormalMaterial();
const cube = new THREE.Mesh(geometry, material);
cube.position.set(0, 0, -0.3); // カメラの30cm前
scene.add(cube);

// ライト（MeshStandardMaterialなどを使う場合）
const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
scene.add(light);

renderer.setAnimationLoop(function () {
  cube.rotation.z += 0.01;
  cube.rotation.y += 0.01;
  renderer.render(scene, camera);
});
```
