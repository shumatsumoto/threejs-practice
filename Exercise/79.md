## 1. 問題タイトル

79 本目：レンズフレア（Lensflare）

## 2. 学習目標

この演習を通じて、以下の技術を習得します。

- `Lensflare` オブジェクトの使用方法
- 強い光源をカメラで捉えた時の光学現象の表現
- テクスチャによるフレアのカスタマイズ

## 3. 新しい概念の解説

**Lensflare（レンズフレア）**
カメラが強い光源（太陽など）を捉えたときに、レンズ内部での光の反射によって生じる「光の輪（ゴースト）」や「光条」のことです。
現実の撮影では邪魔な場合もありますが、CG では「眩しさ」や「空気感」を強調するための演出として積極的に使われます。
`Lensflare` クラスを使うと、光源の位置に合わせて自動的にフレアテクスチャを描画してくれます。

```javascript
import { Lensflare, LensflareElement } from 'three/examples/jsm/objects/Lensflare';

const lensflare = new Lensflare();

// メインの光（中心の大きなフレア）
lensflare.addElement(new LensflareElement(textureMain, 700, 0));

// ゴースト（中心から離れていく小さな光の輪）
lensflare.addElement(new LensflareElement(textureSub, 60, 0.6));
lensflare.addElement(new LensflareElement(textureSub, 70, 0.7));

light.add(lensflare);
```

## 4. 課題の説明

太陽のような強い光源にレンズフレアを追加してください。
カメラが光源に向いたときに、六角形や円形の光の輪（ゴースト）が表示されるようにします。

## 5. 必須要件

以下の機能を実装してください。

- **準備**:
  `three/examples/jsm/objects/Lensflare.js` から `Lensflare`, `LensflareElement` をインポートします。
  背景は黒（`scene.background = new THREE.Color(0x000000)`）にして光を見やすくします。

- **光源**:
  `PointLight` を作成し、遠く（z = -200 など）に配置します。

- **レンズフレア構築**:
  1. `TextureLoader` でフレア用画像（`lensflare0.png` 等）を読み込みます。
  2. `const lensflare = new Lensflare()` を作成します。
  3. `lensflare.addElement(new LensflareElement(texture, size, distance))` を使って要素を追加します。
     - メインの光（distance = 0）
     - ゴースト（distance = 0.6 〜 1.0 など複数）
  4. `light.add(lensflare)` でライトに追加します。

- **確認**:
  ライトの前に「遮蔽物（Boxなど）」を置き、その裏にライトが回ったときにフレアが消えることを確認します。

## 6. ヒント

- **ヒント 1（クラスのインポート）**:
  `Lensflare` と `LensflareElement` はコアライブラリではなく `examples/jsm/objects/Lensflare.js` にあります。
- **ヒント 2（セットアップ手順）**:
  1. `new Lensflare()` でインスタンス作成。
  2. `addElement` でテクスチャとサイズを追加。
  3. 光源（`PointLight`など）に `add` する。
  これで光源の位置に追従します。
- **ヒント 3（遮蔽判定）**:
  `Lensflare` は自動的にデプスバッファをチェックし、手前に物体があるときはフレアを消してくれます。
  特別なコードを書く必要はありません。
- **ヒント 4（テクスチャの選択）**:
  フレア用の画像は、背景が透明または黒で、加算合成に適したものが必要です。
  Three.js のサンプル画像 (`lensflare0.png` 〜 `lensflare3.png`) が優秀です。
- **ヒント 5（背景色）**:
  背景が明るい白だとフレアが見えにくいため、宇宙空間（黒）や暗いシーンで使うのが効果的です。

## 7. スターターコード

```javascript
import * as THREE from "three";
// import { Lensflare, LensflareElement } ...

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(
  75,
  window.innerWidth / window.innerHeight,
  0.1,
  1000
);
const renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const light = new THREE.PointLight(0xffffff, 1.5, 2000);
light.position.set(0, 0, -10);
scene.add(light);

// --- ここでレンズフレアを追加 ---
// const textureLoader = new THREE.TextureLoader();
// const texture0 = textureLoader.load('...');
// const lensflare = new Lensflare();
// lensflare.addElement(new LensflareElement(texture0, 500, 0));
// light.add(lensflare);

camera.position.z = 5;

function animate() {
  requestAnimationFrame(animate);

  // ライトを動かす
  light.position.x = Math.sin(Date.now() * 0.001) * 10;

  renderer.render(scene, camera);
}
animate();
```

## 8. 模範解答

```javascript
import * as THREE from "three";
import {
  Lensflare,
  LensflareElement,
} from "three/examples/jsm/objects/Lensflare";

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(
  75,
  window.innerWidth / window.innerHeight,
  0.1,
  1000
);
const renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth, window.innerHeight);
// 背景を黒くしないとフレアが見えにくい
scene.background = new THREE.Color(0x000000);
document.body.appendChild(renderer.domElement);

const light = new THREE.PointLight(0xffffff, 1.5, 2000);
light.position.set(0, 0, -20);
scene.add(light);

const textureLoader = new THREE.TextureLoader();
const texture0 = textureLoader.load(
  "https://threejs.org/examples/textures/lensflare/lensflare0.png"
);
const texture3 = textureLoader.load(
  "https://threejs.org/examples/textures/lensflare/lensflare3.png"
);

const lensflare = new Lensflare();

// メインの光
lensflare.addElement(new LensflareElement(texture0, 700, 0));

// ゴースト（小さい光の輪）
lensflare.addElement(new LensflareElement(texture3, 60, 0.6));
lensflare.addElement(new LensflareElement(texture3, 70, 0.7));
lensflare.addElement(new LensflareElement(texture3, 120, 0.9));
lensflare.addElement(new LensflareElement(texture3, 70, 1.0));

light.add(lensflare);

// 遮蔽物（これに隠れるとフレアも消える）
const box = new THREE.Mesh(
  new THREE.BoxGeometry(5, 5, 5),
  new THREE.MeshNormalMaterial()
);
box.position.z = -10;
scene.add(box);

camera.position.z = 5;

function animate() {
  requestAnimationFrame(animate);

  // ライトを左右に動かす
  light.position.x = Math.sin(Date.now() * 0.001) * 30;

  renderer.render(scene, camera);
}
animate();
```
