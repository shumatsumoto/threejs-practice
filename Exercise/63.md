## 1. 問題タイトル

63 本目：ブルームエフェクト（発光表現）

## 2. 学習目標

この演習を通じて、以下の技術を習得します。

- `UnrealBloomPass` の使用方法
- 輝度しきい値（Threshold）、強度（Strength）、半径（Radius）の調整
- ネオンサインのような光る物体の表現

## 3. 新しい概念の解説

**Bloom Effect（ブルームエフェクト）**
明るい光が周囲に溢れ出すような現象（光の滲み）をシミュレートするポストプロセス技術です。
ネオン管、レーザー、太陽光の反射など、「まぶしさ」を表現するのに不可欠です。
Three.js では `UnrealBloomPass` が最も高品質で一般的です。

```javascript
import { UnrealBloomPass } from 'three/examples/jsm/postprocessing/UnrealBloomPass';

// 解像度, 強度, 半径, しきい値
const bloomPass = new UnrealBloomPass(
  new THREE.Vector2(window.innerWidth, window.innerHeight),
  1.5,  // strength: 光の強さ
  0.4,  // radius: 光の広がり
  0.85  // threshold: これより明るい部分が光る (0.0〜1.0)
);
composer.addPass(bloomPass);
```

## 4. 課題の説明

シーン内の明るい部分がぼんやりと光って見える「ブルーム（Bloom）」エフェクトを追加してください。
黒い背景に、明るい色のキューブを配置し、それが発光しているように見せます。

## 5. 必須要件

以下の機能を実装してください。

- **EffectComposer 設定**:
  `EffectComposer` を作成し、最初のパスとして `RenderPass` を追加します。

- **Bloomパスの追加**:
  `UnrealBloomPass(size, strength, radius, threshold)` を作成し、Composerに追加します。
  - `strength`: 1.5（重要）
  - `threshold`: 0.1（重要：この値より明るいものが光る）

- **発光オブジェクト配置**:
  色を `0x00ff00` など明るい色にしたキューブを配置します。
  マテリアルの色が閾値を超えると、周囲に光が滲み出ることを確認します。
  `composer.render()` をループ内で呼び出します。

## 6. ヒント

- **ヒント 1（必要なクラスのインポート）**:
  ポストプロセスには `EffectComposer`, `RenderPass` が必須です。
  `import { UnrealBloomPass } from 'three/examples/jsm/postprocessing/UnrealBloomPass';`
  も忘れずにインポートしましょう。
- **ヒント 2（パスの構成）**:
  `composer.addPass(new RenderPass(scene, camera))` を最初に追加し、その後に `composer.addPass(bloomPass)` を追加します。
  順番が重要です。
- **ヒント 3（パラメータの調整）**:
  `new UnrealBloomPass(resolution, strength, radius, threshold)` です。
  `strength`（例: 1.5）で光の強さ、`radius`（例: 0.4）で光の広がり、`threshold`（例: 0.85）で「これより明るい部分を光らせる」閾値を指定します。
- **ヒント 4（発光させるコツ）**:
  `threshold` を低くする（例: 0.1）か、マテリアルの色を非常に明るく（例: `color: 0x00ff00` や `emissive: 0x00ff00`）すると、ブルーム効果がはっきりと出ます。
  暗いシーンの方が効果が目立ちます。
- **ヒント 5（描画ループの変更）**:
  `animate` 関数内では `renderer.render(scene, camera)` の代わりに `composer.render()` を呼び出す必要があります。

## 7. スターターコード

```javascript
import * as THREE from "three";
import { EffectComposer } from "three/examples/jsm/postprocessing/EffectComposer";
import { RenderPass } from "three/examples/jsm/postprocessing/RenderPass";
// import { UnrealBloomPass } ...

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(
  75,
  window.innerWidth / window.innerHeight,
  0.1,
  1000
);
const renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth, window.innerHeight);
// トーンマッピング設定（ブルームと相性が良い）
renderer.toneMapping = THREE.ReinhardToneMapping;
document.body.appendChild(renderer.domElement);

const geometry = new THREE.BoxGeometry(1, 1, 1);
const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 }); // 明るい緑
const cube = new THREE.Mesh(geometry, material);
scene.add(cube);

// --- ここでComposerとBloomPassを設定 ---

camera.position.z = 5;

function animate() {
  requestAnimationFrame(animate);
  cube.rotation.x += 0.01;
  cube.rotation.y += 0.01;
  // composer.render();
}
animate();
```

## 8. 模範解答

```javascript
import * as THREE from "three";
import { EffectComposer } from "three/examples/jsm/postprocessing/EffectComposer";
import { RenderPass } from "three/examples/jsm/postprocessing/RenderPass";
import { UnrealBloomPass } from "three/examples/jsm/postprocessing/UnrealBloomPass";

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(
  75,
  window.innerWidth / window.innerHeight,
  0.1,
  1000
);
const renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const geometry = new THREE.BoxGeometry(1, 1, 1);
// 発光させるため、Emissive（自己発光）を設定するか、BasicMaterialで明るい色にする
const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
const cube = new THREE.Mesh(geometry, material);
scene.add(cube);

// 複数配置
const cube2 = new THREE.Mesh(
  geometry,
  new THREE.MeshBasicMaterial({ color: 0xff0000 })
);
cube2.position.x = 2;
scene.add(cube2);

// Composer設定
const composer = new EffectComposer(renderer);
composer.addPass(new RenderPass(scene, camera));

// ブルームパス
// 解像度, 強度, 半径, しきい値
const bloomPass = new UnrealBloomPass(
  new THREE.Vector2(window.innerWidth, window.innerHeight),
  1.5, // strength
  0.4, // radius
  0.1 // threshold (これより明るい部分が光る)
);
composer.addPass(bloomPass);

camera.position.z = 5;

function animate() {
  requestAnimationFrame(animate);

  cube.rotation.x += 0.01;
  cube.rotation.y += 0.01;
  cube2.rotation.x -= 0.01;

  composer.render();
}
animate();
```
