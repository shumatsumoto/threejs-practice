## 1. 問題タイトル

27 本目：星空の作成

## 2. 学習目標

この演習を通じて、以下の技術を習得します。

- パーティクルシステムの応用
- 範囲の広い空間演出
- 背景としての 3D オブジェクト活用

## 3. 新しい概念の解説

**Scene Scale（シーンのスケール）**
3D 空間には物理的な「壁」はありませんが、カメラには「見える範囲（クリッピング面）」があります。
遠くの星などを表現する場合、カメラの `far`（遠クリップ面）を十分に大きく設定し、オブジェクトも広範囲（例: -1000〜+1000）に配置する必要があります。

```javascript
// Farを2000に設定して、遠くまで見えるようにする
const camera = new THREE.PerspectiveCamera(75, aspect, 0.1, 2000);

// 非常に遠くに配置
star.position.z = -1500;
```

## 4. 課題の説明

演習 26 を応用して、カメラを取り囲む広大な「星空」を作成してください。
カメラが動いても常に星背景があるように、非常に広い範囲（例：半径 100 以上）に配置します。

## 5. 必須要件

以下の機能を実装してください。

- **カメラのFar設定**:
  `new THREE.PerspectiveCamera` の第4引数（Far）を `2000` など大きく設定し、遠くの星が見えるようにします。

- **大量の星の生成**:
  演習26と同様に `BufferGeometry` を使い、個数を 5000 個以上に増やします。
  座標の散布範囲も広くします（例: -1000 〜 +1000）。

- **サイズ調整**:
  `PointsMaterial` の `size` を調整し、遠くにあっても見える適度な大きさ（例: 2〜3）にします。

- **アニメーション**:
  `Points` オブジェクト全体をゆっくりと回転させ、天球が回っているような演出を加えます。

## 6. ヒント

- **ヒント 1（配置範囲）**:
  `Math.random()` は 0〜1 なので、`(Math.random() - 0.5) * 2000` とすると -1000 〜 +1000 の範囲になります。
  カメラが原点にあるなら、全方向に星が散らばります。
- **ヒント 2（カメラ設定）**:
  遠くの星が表示されない場合は、`new THREE.PerspectiveCamera(...)` の第4引数（Far Clip）を確認してください。デフォルトは 1000 なので、それより遠くは消えます。2000 程度に増やしましょう。
- **ヒント 3（回転）**:
  個々の点を動かすのではなく、点が集まっているコンテナ（`Points` オブジェクト）自体を回転させれば、天球全体が回っているように見えます。
- **ヒント 4（サイズ）**:
  あまりに遠くへ配置すると、点が見えにくくなることがあります。`PointsMaterial` の `size` を少し大きめ（2〜3）に調整してください。
- **ヒント 5（用途）**:
  このテクニックは「スカイボックス」の代わりとしてよく使われます。背景画像を使うよりも立体的でダイナミックな宇宙表現が可能です。

## 7. スターターコード

```javascript
import * as THREE from "three";

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(
  75,
  window.innerWidth / window.innerHeight,
  0.1,
  2000
); // Farを大きく
const renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// --- ここで星空を作成してください ---

function animate() {
  requestAnimationFrame(animate);
  // 星空を回転
  renderer.render(scene, camera);
}
animate();
```

## 8. 模範解答

```javascript
import * as THREE from "three";

const scene = new THREE.Scene();
// 遠くまで見えるようにFarクリップ面を大きく設定
const camera = new THREE.PerspectiveCamera(
  75,
  window.innerWidth / window.innerHeight,
  0.1,
  2000
);
const renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const geometry = new THREE.BufferGeometry();
const count = 5000;
const positions = new Float32Array(count * 3);

for (let i = 0; i < count * 3; i++) {
  // -1000 〜 +1000 の広大な範囲に配置
  positions[i] = (Math.random() - 0.5) * 2000;
}

geometry.setAttribute("position", new THREE.BufferAttribute(positions, 3));

const material = new THREE.PointsMaterial({
  size: 2, // 遠くにあるので少し大きめに
  color: 0xffffff,
});

const starField = new THREE.Points(geometry, material);
scene.add(starField);

function animate() {
  requestAnimationFrame(animate);

  // 宇宙の雄大さを出すために極めてゆっくり回す
  starField.rotation.y += 0.0005;

  renderer.render(scene, camera);
}
animate();
```
